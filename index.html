<!DOCTYPE html>
<html lang="ko" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- â–¼â–¼â–¼ [ì¤‘ìš”] ìë™ ë²ˆì—­ ë°©ì§€ íƒœê·¸ ì¶”ê°€ â–¼â–¼â–¼ -->
    <meta name="google" content="notranslate">
    <title>Hugo Aesthetic Consult</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hugo Consult">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">

    <!-- ì—ëŸ¬ ë°©ì§€ìš© ìŠ¤íƒ€ì¼ -->
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        body { background-color: #171717; color: white; touch-action: manipulation; }
        .loader { border: 3px solid #333; border-top: 3px solid #f59e0b; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-log { display: none; position: fixed; top: 0; left: 0; width: 100%; background: red; color: white; padding: 10px; z-index: 9999; }
    </style>

    <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="notranslate">
    <div id="error-log"></div>
    <div id="root"></div>

    <script>
        // ì•ˆì „ ì¥ì¹˜: ì—ëŸ¬ ë°œìƒ ì‹œ í™”ë©´ì— í‘œì‹œ
        window.onerror = function(msg, url, line) {
            // ë²ˆì—­ê¸° ì˜¤ë¥˜ ë¬´ì‹œ
            if (msg.includes("removeChild") || msg.includes("insertBefore")) {
                console.warn("ë²ˆì—­ê¸° ì¶©ëŒ ê°ì§€ë¨ (ë¬´ì‹œí•¨)");
                return true; 
            }
            const errorBox = document.getElementById('error-log');
            errorBox.style.display = 'block';
            errorBox.innerHTML = `ì˜¤ë¥˜ ë°œìƒ: ${msg} (ì¤„: ${line}) <br> ê´€ë¦¬ìì—ê²Œ ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”.`;
            return false;
        };
    </script>

    <!-- íŒŒì´ì–´ë² ì´ìŠ¤ ì—°ê²° ì„¤ì • (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â–¼â–¼â–¼ íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • (ì›ì¥ë‹˜ ì „ìš©) â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyAbyo6KDRVji00Knp7gXicS2FHJts_l3_s",
            authDomain: "hugo-consult.firebaseapp.com",
            projectId: "hugo-consult",
            storageBucket: "hugo-consult.firebasestorage.app",
            messagingSenderId: "445939856276",
            appId: "1:445939856276:web:a0d00cad2f1ca756d05581"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.firestore = { collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
            console.log("Firebase Connected");
        } catch(e) {
            console.error("Firebase Connection Failed", e);
            alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨: " + e.message);
        }
    </script>

    <!-- ë¦¬ì•¡íŠ¸ ì•± ë¡œì§ -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ ì•ˆì „í•˜ê²Œ ê°ì‹¸ê¸°
        const IconWrapper = ({ name, ...props }) => {
            return <i data-lucide={name} {...props}></i>;
        };

        const Icons = {
            ScanFace: (props) => <IconWrapper name="scan-face" {...props} />,
            ArrowLeft: (props) => <IconWrapper name="arrow-left" {...props} />,
            Activity: (props) => <IconWrapper name="activity" {...props} />,
            Layers: (props) => <IconWrapper name="layers" {...props} />,
            User: (props) => <IconWrapper name="user" {...props} />,
            Scissors: (props) => <IconWrapper name="scissors" {...props} />,
            Sparkles: (props) => <IconWrapper name="sparkles" {...props} />,
            Smile: (props) => <IconWrapper name="smile" {...props} />,
            Syringe: (props) => <IconWrapper name="syringe" {...props} />,
            Settings: (props) => <IconWrapper name="settings" {...props} />,
            X: (props) => <IconWrapper name="x" {...props} />,
            Plus: (props) => <IconWrapper name="plus" {...props} />,
            Trash2: (props) => <IconWrapper name="trash-2" {...props} />,
            Edit2: (props) => <IconWrapper name="edit-2" {...props} />,
            Monitor: (props) => <IconWrapper name="monitor" {...props} />,
            Upload: (props) => <IconWrapper name="upload" {...props} />,
            Check: (props) => <IconWrapper name="check" {...props} />,
            EyeOff: (props) => <IconWrapper name="eye-off" {...props} />
        };

        const CATEGORIES = [
            { id: 'lifting_face', name: 'ì•ˆë©´ëª©ê±°ìƒ', icon: 'ScanFace', tags: ['ì „ì²´', 'ë¯¸ë‹ˆê±°ìƒ', 'ëª©ê±°ìƒ', 'ì¬ìˆ˜ìˆ '] },
            { id: 'lifting_forehead', name: 'ì´ë§ˆê±°ìƒ', icon: 'ArrowLeft', rotateIcon: 90, tags: ['ì „ì²´', 'ë‚´ì‹œê²½', 'ì¶•ì†Œë³‘í–‰'] },
            { id: 'eyes_middle', name: 'ì¤‘ë…„ëˆˆì„±í˜•', icon: 'Activity', tags: ['ì „ì²´', 'ìƒì•ˆê²€', 'í•˜ì•ˆê²€', 'ëˆˆë°‘ì§€ë°©ì¬ë°°ì¹˜'] },
            { id: 'thread', name: 'ì‹¤ë¦¬í”„íŒ…', icon: 'Layers', tags: ['ì „ì²´', 'ë¯¼íŠ¸', 'ì‹¤ë£¨ì—£ì†Œí”„íŠ¸', 'ì¼ë²„'] },
            { id: 'ears', name: 'ê·€ì„±í˜•', icon: 'User', tags: ['ì „ì²´', 'ëŒì¶œê·€', 'ì´ìˆ˜ì—´', 'ì¼ˆë¡œì´ë“œ'] },
            { id: 'nose', name: 'ì½”ì„±í˜•', icon: 'User', tags: ['ì „ì²´', 'ë‚®ì€ì½”', 'ë§¤ë¶€ë¦¬', 'ë³µì½”', 'ì¬ìˆ˜ìˆ '] },
            { id: 'lipo', name: 'ì§€ë°©í¡ì…', icon: 'Scissors', tags: ['ì „ì²´', 'íŒ”', 'ë³µë¶€', 'í—ˆë²…ì§€', 'ì–¼êµ´', 'ì¢…ì•„ë¦¬'] },
            { id: 'fat_graft', name: 'ì§€ë°©ì´ì‹', icon: 'Sparkles', tags: ['ì „ì²´', 'í’€í˜ì´ìŠ¤', 'ì´ë§ˆ', 'ì•ê´‘ëŒ€'] },
            { id: 'philtrum', name: 'ì¸ì¤‘ì¶•ì†Œ(Cì»¬)', icon: 'Smile', tags: ['ì „ì²´', 'ë‚´ì¸¡', 'ì™¸ì¸¡', 'ì…ê¼¬ë¦¬'] },
            { id: 'petit', name: 'í•„ëŸ¬&ë³´í†¡ìŠ¤', icon: 'Syringe', tags: ['ì „ì²´', 'ì…ìˆ í•„ëŸ¬', 'ì• êµí•„ëŸ¬', 'ì´ë§ˆí•„ëŸ¬', 'ì£¼ë¦„ë³´í†¡ìŠ¤'] },
        ];

        // ì´ë¯¸ì§€ ì²˜ë¦¬ í•¨ìˆ˜ (ì••ì¶• + ë¸”ëŸ¬)
        const processImage = (file, blurPoints = []) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        if (blurPoints.length > 0) {
                            blurPoints.forEach(point => {
                                const x = point.x * canvas.width;
                                const y = point.y * canvas.height;
                                const radius = 40; 
                                ctx.save();
                                ctx.beginPath();
                                ctx.arc(x, y, radius, 0, Math.PI * 2);
                                ctx.clip();
                                
                                // ëª¨ìì´í¬ íš¨ê³¼
                                const sampleSize = 10;
                                for (let bx = x - radius; bx < x + radius; bx += sampleSize) {
                                    for (let by = y - radius; by < y + radius; by += sampleSize) {
                                        if (Math.sqrt((bx - x)**2 + (by - y)**2) < radius) {
                                            const pixelData = ctx.getImageData(bx, by, 1, 1).data;
                                            ctx.fillStyle = `rgb(${pixelData[0]}, ${pixelData[1]}, ${pixelData[2]})`;
                                            ctx.fillRect(bx, by, sampleSize, sampleSize);
                                        }
                                    }
                                }
                                ctx.restore();
                            });
                        }
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                };
            });
        };

        // ì´ë¯¸ì§€ í¸ì§‘ê¸° (ë¸”ëŸ¬ í„°ì¹˜ìš©)
        const ImageEditor = ({ imageSrc, onSave, onCancel }) => {
            const [blurPoints, setBlurPoints] = useState([]);
            const imgRef = useRef(null);

            const handleImageClick = (e) => {
                if (!imgRef.current) return;
                const rect = imgRef.current.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width;
                const y = (e.clientY - rect.top) / rect.height;
                setBlurPoints([...blurPoints, { x, y }]);
            };

            return (
                <div className="fixed inset-0 bg-black z-[60] flex flex-col items-center justify-center p-4">
                    <div className="relative max-w-full max-h-[70vh]">
                        <img ref={imgRef} src={imageSrc} className="max-w-full max-h-[70vh] object-contain border border-neutral-700" onClick={handleImageClick} />
                        {blurPoints.map((p, i) => (
                            <div key={i} className="absolute w-12 h-12 bg-white/20 backdrop-blur-md rounded-full border border-white/50 pointer-events-none" style={{ left: `${p.x * 100}%`, top: `${p.y * 100}%`, transform: 'translate(-50%, -50%)' }} />
                        ))}
                    </div>
                    <p className="text-white text-sm mt-3 mb-4 bg-neutral-800 px-3 py-1 rounded-full">ğŸ‘† ê°€ë¦¬ê³  ì‹¶ì€ ë¶€ìœ„ë¥¼ í„°ì¹˜í•˜ì„¸ìš”</p>
                    <div className="flex gap-3 w-full max-w-xs">
                        <button onClick={onCancel} className="flex-1 py-3 bg-neutral-700 text-white rounded-lg">ì·¨ì†Œ</button>
                        <button onClick={() => setBlurPoints(blurPoints.slice(0, -1))} className="flex-1 py-3 bg-neutral-600 text-white rounded-lg">ë˜ëŒë¦¬ê¸°</button>
                        <button onClick={() => onSave(blurPoints)} className="flex-1 py-3 bg-amber-600 text-white rounded-lg font-bold">ì™„ë£Œ</button>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState(false);
            const handleNumClick = (num) => {
                if (pin.length < 4) {
                    const newPin = pin + num;
                    setPin(newPin);
                    if (newPin.length === 4) {
                        if (newPin === '0000') setTimeout(() => onLogin(false), 300);
                        else if (newPin === '9999') setTimeout(() => onLogin(true), 300);
                        else { setError(true); setTimeout(() => { setPin(''); setError(false); }, 1000); }
                    }
                }
            };
            return (
                <div className="min-h-screen bg-neutral-900 flex flex-col items-center justify-center p-6 text-white relative">
                    <div className="z-10 w-full max-w-sm flex flex-col items-center space-y-10">
                        <div className="text-center space-y-2">
                            <h1 className="text-3xl font-serif tracking-widest text-amber-500/90">HUGO</h1>
                            <p className="text-xs tracking-[0.3em] text-neutral-400 uppercase">Plastic Surgery</p>
                        </div>
                        <div className="flex space-x-4 mb-4">
                            {[0, 1, 2, 3].map((i) => <div key={i} className={`w-4 h-4 rounded-full border border-neutral-600 ${pin.length > i ? 'bg-amber-500 border-amber-500' : 'bg-transparent'}`} />)}
                        </div>
                        {error && <p className="text-red-400 text-sm absolute top-1/2 mt-[-60px]">PIN ë²ˆí˜¸ ì˜¤ë¥˜</p>}
                        <div className="grid grid-cols-3 gap-6 w-full px-4">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => <button key={num} onClick={() => handleNumClick(num.toString())} className="w-16 h-16 rounded-full border border-neutral-700 bg-neutral-800/50 text-2xl font-light active:scale-95">{num}</button>)}
                            <div className="flex justify-center items-center"><button onClick={() => setPin('')} className="text-sm text-neutral-500">ì·¨ì†Œ</button></div>
                            <button onClick={() => handleNumClick('0')} className="w-16 h-16 rounded-full border border-neutral-700 bg-neutral-800/50 text-2xl font-light active:scale-95">0</button>
                            <div className="flex justify-center items-center"><button onClick={() => setPin(pin.slice(0, -1))} className="w-16 h-16 flex items-center justify-center text-neutral-400"><Icons.ArrowLeft size={24} /></button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const CompareSlider = ({ beforeImage, afterImage }) => {
            const [sliderPosition, setSliderPosition] = useState(50);
            const containerRef = useRef(null);
            const handleMove = (e) => {
                if (containerRef.current) {
                    const rect = containerRef.current.getBoundingClientRect();
                    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                    setSliderPosition(Math.max(0, Math.min(100, (x / rect.width) * 100)));
                }
            };
            return (
                <div ref={containerRef} className="relative w-full aspect-[4/5] overflow-hidden rounded-lg bg-black" onMouseMove={handleMove} onTouchMove={handleMove}>
                    {afterImage ? <img src={afterImage} className="absolute inset-0 w-full h-full object-contain" /> : <div className="absolute inset-0 flex items-center justify-center text-neutral-700 text-xs">After ì´ë¯¸ì§€ ì—†ìŒ</div>}
                    <div className="absolute top-4 right-4 bg-black/60 text-white text-xs px-2 py-1 rounded">After</div>
                    <div className="absolute inset-0 overflow-hidden" style={{ width: `${sliderPosition}%` }}>
                        {beforeImage ? <img src={beforeImage} className="absolute inset-0 max-w-none h-full w-full object-contain" style={{ width: containerRef.current?.offsetWidth }} /> : <div className="absolute inset-0 flex items-center justify-center bg-neutral-900 text-neutral-700 text-xs" style={{ width: containerRef.current?.offsetWidth }}>Before ì´ë¯¸ì§€ ì—†ìŒ</div>}
                        <div className="absolute top-4 left-4 bg-black/60 text-white text-xs px-2 py-1 rounded">Before</div>
                    </div>
                    <div className="absolute inset-y-0 w-0.5 bg-white shadow-lg z-30" style={{ left: `${sliderPosition}%` }}>
                        <div className="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-8 h-8 bg-white/20 backdrop-blur rounded-full border border-white flex items-center justify-center"><div className="w-0.5 h-3 bg-white mr-0.5"/><div className="w-0.5 h-3 bg-white"/></div>
                    </div>
                </div>
            );
        };

        // ì—…ë¡œë“œ/ìˆ˜ì • ëª¨ë‹¬
        const CaseModal = ({ onClose, categories, initialData = null }) => {
            const [uploading, setUploading] = useState(false);
            const [data, setData] = useState({ categoryId: categories[0].id, patientId: '', desc: '', tags: '', frontBefore: null, frontAfter: null, angleBefore: null, angleAfter: null, sideBefore: null, sideAfter: null });
            const [editingImage, setEditingImage] = useState(null);

            useEffect(() => {
                if (initialData) {
                    setData({
                        categoryId: initialData.categoryId,
                        patientId: initialData.patientId,
                        desc: initialData.description,
                        tags: initialData.tags ? initialData.tags.join(', ') : '',
                        frontBefore: initialData.images?.front?.before || null,
                        frontAfter: initialData.images?.front?.after || null,
                        angleBefore: initialData.images?.angle45?.before || null,
                        angleAfter: initialData.images?.angle45?.after || null,
                        sideBefore: initialData.images?.side?.before || null,
                        sideAfter: initialData.images?.side?.after || null,
                    });
                }
            }, [initialData]);
            
            const handleFileSelect = (e, key) => {
                if (e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setEditingImage({ key, file, preview: e.target.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleBlurSave = async (blurPoints) => {
                if (!editingImage) return;
                const processedImage = await processImage(editingImage.file, blurPoints);
                setData(prev => ({ ...prev, [editingImage.key]: processedImage }));
                setEditingImage(null);
            };

            const handleSave = async () => {
                if(!window.db) return alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
                if(!data.patientId || !data.desc) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                
                setUploading(true);
                try {
                    const { collection, addDoc, updateDoc, doc, serverTimestamp } = window.firestore;
                    const docData = {
                        categoryId: data.categoryId,
                        patientId: data.patientId,
                        description: data.desc,
                        tags: data.tags.split(',').map(t=>t.trim()).filter(t=>t),
                        images: { 
                            front: { before: data.frontBefore, after: data.frontAfter },
                            angle45: { before: data.angleBefore, after: data.angleAfter },
                            side: { before: data.sideBefore, after: data.sideAfter }
                        }
                    };

                    if (initialData) {
                        await updateDoc(doc(window.db, "cases", initialData.id), docData);
                        alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        docData.createdAt = serverTimestamp();
                        await addDoc(collection(window.db, "cases"), docData);
                        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    onClose();
                } catch(e) {
                    alert("ì˜¤ë¥˜: " + e.message);
                } finally {
                    setUploading(false);
                }
            };

            const FileInput = ({ label, bindKeyBefore, bindKeyAfter }) => (
                <div className="space-y-1">
                    <p className="text-xs text-neutral-400 ml-1">{label}</p>
                    <div className="grid grid-cols-2 gap-2">
                        <label className={`aspect-[4/3] border border-dashed border-neutral-600 rounded flex flex-col items-center justify-center cursor-pointer transition-colors ${data[bindKeyBefore] ? 'bg-neutral-800 border-amber-500' : 'bg-neutral-900 hover:bg-neutral-800'}`}>
                            {data[bindKeyBefore] ? <Icons.Check className="text-amber-500" size={16}/> : <span className="text-[10px] text-neutral-500">Before (í„°ì¹˜)</span>}
                            <input type="file" hidden accept="image/*" onChange={e=>handleFileSelect(e, bindKeyBefore)}/>
                        </label>
                        <label className={`aspect-[4/3] border border-dashed border-neutral-600 rounded flex flex-col items-center justify-center cursor-pointer transition-colors ${data[bindKeyAfter] ? 'bg-neutral-800 border-amber-500' : 'bg-neutral-900 hover:bg-neutral-800'}`}>
                            {data[bindKeyAfter] ? <Icons.Check className="text-amber-500" size={16}/> : <span className="text-[10px] text-neutral-500">After (í„°ì¹˜)</span>}
                            <input type="file" hidden accept="image/*" onChange={e=>handleFileSelect(e, bindKeyAfter)}/>
                        </label>
                    </div>
                </div>
            );

            return (
                <>
                    {editingImage && <ImageEditor imageSrc={editingImage.preview} onSave={handleBlurSave} onCancel={() => setEditingImage(null)} />}
                    
                    <div className={`fixed inset-0 bg-black/90 z-50 p-4 overflow-y-auto flex items-center justify-center ${editingImage ? 'hidden' : ''}`}>
                        <div className="bg-neutral-800 rounded-xl p-6 w-full max-w-lg space-y-4 border border-neutral-700 max-h-[90vh] overflow-y-auto">
                            <div className="flex justify-between items-center border-b border-neutral-700 pb-3">
                                <h3 className="text-lg font-medium text-white">{initialData ? 'ì¼€ì´ìŠ¤ ìˆ˜ì •' : 'ìƒˆ ì¼€ì´ìŠ¤ ë“±ë¡'}</h3>
                                <button onClick={onClose}><Icons.X size={20}/></button>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs text-neutral-500 block mb-1">ì¹´í…Œê³ ë¦¬</label>
                                    <select className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-sm text-white" value={data.categoryId} onChange={e=>setData({...data, categoryId: e.target.value})}>
                                        {categories.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-neutral-500 block mb-1">í™˜ì ID</label>
                                    <input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-sm text-white" placeholder="ì˜ˆ: 240101-A" value={data.patientId} onChange={e=>setData({...data, patientId: e.target.value})}/>
                                </div>
                            </div>
                            <input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-sm text-white" placeholder="ìˆ˜ìˆ  ë‚´ìš©" value={data.desc} onChange={e=>setData({...data, desc: e.target.value})}/>
                            <input className="w-full bg-neutral-900 border border-neutral-700 rounded p-2 text-sm text-white" placeholder="íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)" value={data.tags} onChange={e=>setData({...data, tags: e.target.value})}/>
                            
                            <div className="space-y-3 pt-2 border-t border-neutral-700">
                                <FileInput label="1. ì •ë©´" bindKeyBefore="frontBefore" bindKeyAfter="frontAfter" />
                                <FileInput label="2. 45ë„" bindKeyBefore="angleBefore" bindKeyAfter="angleAfter" />
                                <FileInput label="3. ì¸¡ë©´" bindKeyBefore="sideBefore" bindKeyAfter="sideAfter" />
                            </div>
                            <button onClick={handleSave} disabled={uploading} className="w-full bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-lg font-bold text-sm flex justify-center mt-4">
                                {uploading ? <div className="loader"/> : (initialData ? "ìˆ˜ì • ì™„ë£Œ" : "ì €ì¥ ë° ì—…ë¡œë“œ")}
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        const App = () => {
            const [view, setView] = useState('LOGIN');
            const [isAdmin, setIsAdmin] = useState(false);
            const [cases, setCases] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [selectedTag, setSelectedTag] = useState('ì „ì²´');
            const [selectedCase, setSelectedCase] = useState(null);
            const [caseViewType, setCaseViewType] = useState('front');
            const [modalOpen, setModalOpen] = useState(false);
            const [editingCase, setEditingCase] = useState(null);

            useEffect(() => {
                if(window.lucide) window.lucide.createIcons();
            });

            useEffect(() => {
                if(window.db && window.firestore) {
                    const { collection, onSnapshot, query, orderBy } = window.firestore;
                    const q = query(collection(window.db, "cases"), orderBy("createdAt", "desc"));
                    const unsub = onSnapshot(q, (snapshot) => {
                        const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setCases(list);
                    }, (err) => console.log("DB Wait", err));
                    return () => unsub();
                }
            }, [view]);

            const handleDelete = async (e, id) => {
                e.stopPropagation();
                if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    const { deleteDoc, doc } = window.firestore;
                    await deleteDoc(doc(window.db, "cases", id));
                }
            };

            const handleEdit = (e, item) => {
                e.stopPropagation();
                setEditingCase(item);
                setModalOpen(true);
            };

            const CategoryIcon = ({ name, rotate }) => {
                return <IconWrapper name={name} className={`w-5 h-5 ${rotate ? 'rotate-'+rotate : ''}`} />;
            };

            if (view === 'LOGIN') return <LoginScreen onLogin={(admin) => { setIsAdmin(admin); setView('DASHBOARD'); }} />;

            const filteredCases = selectedCategory ? cases.filter(c => c.categoryId === selectedCategory.id && (selectedTag === 'ì „ì²´' || (c.tags && c.tags.includes(selectedTag)))) : [];

            return (
                <div className="bg-neutral-900 min-h-screen text-neutral-100 font-sans selection:bg-amber-500/30">
                    <header className="fixed top-0 w-full z-40 bg-neutral-900/90 backdrop-blur-md border-b border-neutral-800 h-14 flex items-center justify-between px-4">
                        {view !== 'DASHBOARD' ? <button onClick={() => view === 'DETAIL' ? setView('LIST') : setView('DASHBOARD')}><IconWrapper name="arrow-left" className="w-5 h-5 text-white" /></button> : <div className="w-5"/>}
                        <h2 className="font-serif text-lg text-amber-500/90 tracking-widest">{view === 'DASHBOARD' ? 'HUGO' : selectedCategory?.name}</h2>
                        {isAdmin ? <button onClick={()=>{setEditingCase(null); setModalOpen(true);}} className="text-amber-500"><IconWrapper name="plus" className="w-6 h-6" /></button> : <div className="w-5"/>}
                    </header>

                    <main className="pt-16 pb-6 px-4 max-w-3xl mx-auto min-h-screen">
                        {view === 'DASHBOARD' && (
                            <div className="animate-fade-in">
                                {isAdmin && <div className="mb-4 bg-amber-900/20 border border-amber-500/30 p-2 rounded text-xs text-amber-500 flex gap-2"><IconWrapper name="monitor" className="w-3 h-3" /> ê´€ë¦¬ì ëª¨ë“œ</div>}
                                <div className="mb-6 text-center pt-2"><h3 className="text-xl font-light text-neutral-300">ìƒë‹´í•˜ì‹¤ <span className="text-amber-500 font-serif italic pr-1">Category</span>ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3></div>
                                <div className="grid grid-cols-2 gap-3">
                                    {CATEGORIES.map((cat) => (
                                        <button key={cat.id} onClick={() => { setSelectedCategory(cat); setSelectedTag('ì „ì²´'); setView('LIST'); }} className="bg-neutral-800 border border-neutral-700/50 hover:border-amber-500/50 rounded-lg p-5 flex flex-col items-center gap-3 aspect-[1.1/1]">
                                            <div className="w-10 h-10 rounded-full bg-neutral-900 flex items-center justify-center text-amber-500">
                                                <CategoryIcon name={cat.icon} rotate={cat.rotateIcon} />
                                            </div>
                                            <span className="text-sm font-medium text-neutral-300">{cat.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'LIST' && (
                            <div className="animate-fade-in">
                                <div className="overflow-x-auto pb-4 -mx-4 px-4 scrollbar-hide flex gap-2 w-max">
                                    {selectedCategory.tags.map(tag => <button key={tag} onClick={() => setSelectedTag(tag)} className={`px-4 py-1.5 rounded-full text-xs border ${selectedTag === tag ? 'bg-amber-500 border-amber-500 text-neutral-900' : 'border-neutral-700 text-neutral-400'}`}>#{tag}</button>)}
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    {filteredCases.length > 0 ? filteredCases.map(item => (
                                        <div key={item.id} onClick={() => { setSelectedCase(item); setCaseViewType('front'); setView('DETAIL'); }} className="relative bg-neutral-800 rounded-lg overflow-hidden border border-neutral-700/50 aspect-[4/5] cursor-pointer group">
                                            <img src={item.images.front?.after || item.images.front?.before} className="w-full h-full object-cover opacity-90 group-hover:opacity-100" />
                                            <div className="absolute inset-0 bg-gradient-to-t from-neutral-900/90 via-transparent to-transparent opacity-60" />
                                            <div className="absolute bottom-2 left-3 right-3">
                                                <p className="text-[10px] text-amber-500 font-bold mb-0.5">{item.tags && item.tags[0]}</p>
                                                <p className="text-xs text-neutral-200 line-clamp-1">{item.description}</p>
                                            </div>
                                            {isAdmin && (
                                                <div className="absolute top-2 right-2 flex gap-1">
                                                    <button onClick={(e)=>handleEdit(e, item)} className="bg-neutral-800/80 p-1.5 rounded text-white hover:bg-neutral-700"><IconWrapper name="edit-2" className="w-3 h-3" /></button>
                                                    <button onClick={(e)=>handleDelete(e, item.id)} className="bg-red-500/80 p-1.5 rounded text-white hover:bg-red-600"><IconWrapper name="trash-2" className="w-3 h-3" /></button>
                                                </div>
                                            )}
                                        </div>
                                    )) : (
                                        <div className="col-span-2 text-center py-20 text-neutral-500">
                                            <p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                            {isAdmin && <p className="text-xs mt-2">+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”</p>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'DETAIL' && selectedCase && (
                            <div className="animate-fade-in flex flex-col h-[calc(100vh-80px)]">
                                <div className="flex bg-neutral-800 p-1 rounded-lg mb-4 shrink-0 mx-auto w-full max-w-sm">
                                    {['front', 'angle45', 'side'].map((v) => (
                                        <button key={v} onClick={() => setCaseViewType(v)} className={`flex-1 py-2 text-xs font-medium rounded-md transition-all ${caseViewType === v ? 'bg-neutral-700 text-amber-500 shadow-sm' : 'text-neutral-500 hover:text-neutral-300'}`}>
                                            {v === 'front' ? 'ì •ë©´' : v === 'angle45' ? '45ë„' : 'ì¸¡ë©´'}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex-1 flex flex-col justify-center min-h-0">
                                    <div className="w-full relative rounded-xl border border-neutral-700 overflow-hidden shadow-2xl bg-black">
                                        <CompareSlider beforeImage={selectedCase.images[caseViewType]?.before} afterImage={selectedCase.images[caseViewType]?.after} />
                                    </div>
                                    <div className="mt-6 space-y-2">
                                        <div className="flex items-center justify-between"><span className="px-2 py-0.5 bg-neutral-800 text-neutral-400 text-[10px] rounded border border-neutral-700">ID: {selectedCase.patientId}</span></div>
                                        <h3 className="text-lg font-medium text-white">{selectedCase.description}</h3>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {modalOpen && <CaseModal categories={CATEGORIES} onClose={()=>{setModalOpen(false); setEditingCase(null);}} initialData={editingCase} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
